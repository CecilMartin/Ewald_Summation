% !TeX spellcheck = en_GB
\documentclass{article}[12pt]

\renewcommand{\baselinestretch}{1.3}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{enumerate}
\usepackage{latexsym}
\usepackage{mathrsfs}
\usepackage{amsthm}
\usepackage{verbatim}
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{epsfig}
\usepackage{color}
\usepackage{subfig}
\usepackage{float}
\usepackage{color}
\usepackage{titlesec}
\usepackage{bm}
\usepackage[colorlinks,linkcolor=blue,anchorcolor=green,citecolor=red]{hyperref}
\usepackage[T1]{fontenc}
\renewcommand{\rmdefault}{ptm}
\usepackage{charter}
\usepackage{fancyhdr}
\usepackage{amscd}

\usepackage{caption}
\usepackage{algorithm} %format of the algorithm
\usepackage{algorithmic} %format of the algorithm


\makeatletter
\@addtoreset{equation}{section}
\makeatother

\makeatletter % `@' now normal "letter"
\@addtoreset{equation}{section}
\makeatother  % `@' is restored as "non-letter"
\renewcommand\theequation{\oldstylenums{\thesection}%
	.\oldstylenums{\arabic{equation}}}

\usepackage{geometry}
\geometry{left=4cm,right=4cm,top=4cm,bottom=4cm}

\usepackage{listings}
\usepackage{setspace}

\begin{document}

\title{HPC Final Project}

\date{\today}

\maketitle

\section{Algorithm description}

\paragraph{Periodic Stokes potentials}
Given the Stokes equation, the Green's function for the velocity field for the free-space problem is given by the Oseen-Burgers tensor:
\begin{equation}
\mathbf{S}(\mathbf{x}) = \frac{\mathbf{1}}{|\mathbf{x}|} + \frac{\mathbf{x x}}{|\mathbf{x}|^3}.
\end{equation}
Now we consider a system of $N$ point sources at location $\mathbf{x}_n$ with strength $\mathbf{f}_n$, in the periodic setting, the velocity field is given as
\begin{equation}
\mathbf{u}(\mathbf{x}) = \sum_{n=1}^{N} \sum_{\mathbf{p}} \mathbf{S}(\mathbf{x - x_n + p}) \mathbf{f}_n, \label{eq:stokes_velocity_field}
\end{equation}     
where $\mathbf{p}$ form the discrete set $\{[iL_x \ jL_y \  kL_z]:(i, j, k) \in \mathbb{Z}^3\}$ and $L_x, L_y$ and $L_z$ are the periodic lengths in the three directions.

\paragraph{Ewald summation for Stokes}
Applying the idea of Ewald decomposition, the Eq.\eqref{eq:stokes_velocity_field} can be split as following:
\begin{equation}
\mathbf{u}(\mathbf{x}_m) = \sum_{n=1}^{N} \sum_{\mathbf{p}} \mathbf{A}(\xi, \mathbf{x_m - x_n + p}) \mathbf{f}_n + \frac{1}{V} \sum_{\mathbf{k} \neq 0} \mathbf{B}(\xi, \mathbf{k}) e^{-k^2/4\xi^2}\sum_{n=1}^{N} \mathbf{f}_n e ^{-i \mathbf{k} \cdot (\mathbf{x}_m - \mathbf{x}_n)} - \mathbf{u}_{\text{self}} \label{eq:ewald_sum}
\end{equation} 
where $\mathbf{k} \in \{[2 \pi k_i / L_i]: k_i \in \mathbb{Z}, i=1,2,3\}, k = |\mathbf{k}|, V=L_x L_y L_z$ and $\xi$ is a positive constant known as the Ewald parameter. From the Eq.\eqref{eq:ewald_sum} we can see that the velocity field has been split into three parts: one sum in real space ($\mathbf{u}^R$), one sum in frequency domain ($\mathbf{u}^F$) and a self-contribution $\mathbf{u}_{\text{self}}$.

From the formulation by Hasimoto, we have
\begin{equation}
\mathbf{A}(\xi, \mathbf{x}) = 2 \left(\frac{\xi e^{-\xi^2 r^2}}{\sqrt{\pi} r^2} + \frac{\text{erfc}(\xi r)}{2 r^3}\right) (r^2 \mathbf{I} + \mathbf{x x}) - \frac{4 \xi}{\sqrt{\pi}} e^{-\xi^2 r^2} \mathbf{I}
\end{equation}
with $r = |\mathbf{X}|$ and
\begin{equation}
B(\xi, \mathbf{k}) = 8 \pi \left(1 + \frac{k^2}{4 \xi^2}\right) \frac{1}{k^4}(k^2 \mathbf{I} - \mathbf{k k})
\end{equation}
and
\begin{equation}
\mathbf{u}_{\text{self}}(\mathbf{x}_m) = \frac{4 \xi}{\sqrt{\pi}} \mathbf{f}_m
\end{equation}

\paragraph{Nonuniform fast Fourier transform}
The nonuniform discrete Fourier transform (NuFFT) of type 1 and 2 is defined as:
\begin{equation}
F(\mathbf{k}) = \frac{1}{N} \sum_{n=1}^N f_j e^{-i \mathbf{k} \cdot \mathbf{x}_n}
\end{equation}
and
\begin{equation}
f(x_n) = \sum_{\mathbf{k}} F(\mathbf{k}) e^{i \mathbf{k} \cdot \mathbf{x}_n}
\end{equation}
They can be computed efficiently by fast Gaussian gridding and FFT, we will introduce it in the later part.

\paragraph{Fast summation method in frequency domain}
Now we focus on the frequency domain part of the summation based on NuFFT:
\begin{equation}
\mathbf{u}^F (\mathbf{x}_m) = \frac{1}{V} \sum_{\mathbf{k} \neq 0} \mathbf{B}(\xi, \mathbf{k}) e^{-k^2/4\xi^2}\sum_{n=1}^{N} \mathbf{f}_n e ^{-i \mathbf{k} \cdot (\mathbf{x}_m - \mathbf{x}_n)}
\end{equation}
The formula can be split into 
\begin{equation}
\mathbf{u}^F (\mathbf{x}_m) = \frac{1}{V} \sum_{\mathbf{k} \neq 0} \mathbf{B}(\xi, \mathbf{k}) e^{-k^2/4\xi^2} \left(\sum_{n=1}^{N} \mathbf{f}_n e ^{i \mathbf{k} \cdot \mathbf{x}_n} \right)e ^{-i \mathbf{k} \cdot \mathbf{x}_m}
\end{equation}
which is one NuFFT (type 1) combined with scaling and another NuFFT (type 2).

\paragraph{Reformulation by Gaussian Gridding \& FFT} 
The basic idea is convolution by the Gaussian... leave it for later.

For NuFFT of type 1, introducing a free parameter $\eta$, we have that
\begin{equation}
\sum_{n=1}^{N} \mathbf{f}_n e ^{i \mathbf{k} \cdot \mathbf{x}_m }  = e^{\eta k^2 / 8 \xi^2} \sum_{n=1}^{N} \mathbf{f}_n e^{-\eta k^2 / 8 \xi^2} e ^{-i (\mathbf{-k}) \cdot \mathbf{x}_m }  := e^{\eta k^2 / 8 \xi^2} \hat{H}_{\mathbf{-k}}
\end{equation}
while $\hat{H}_{\mathbf{k}}$ is the inverse Fourier transform of 
\begin{equation}
H(\mathbf{x}) = \left(\frac{2 \xi^2}{\pi \eta}\right)^{3/2}  \sum_{n=1}^N \mathbf{f}_n e^{-2 \xi^2 |\mathbf{x} - \mathbf{x}_n|_{\ast}^2 / \eta} \label{eq:gaussian_gridding_1}
\end{equation}
where $|\cdot|_{\ast}$ denotes distance to closest periodic image. (\textit{Remark from Guanchun: The distance is a little weird, I haven't checked if it's the inverse Fourier transform or not. Is it common in periodic setting?})

For the part of type 2 NuFFT, under the same parameter $\eta$, first we can simplify 
\begin{align}
\mathbf{u}^F (\mathbf{x}_m) & = \frac{1}{V} \sum_{\mathbf{k} \neq 0} \mathbf{B}(\xi, \mathbf{k}) e^{-k^2/4\xi^2} e^{\eta k^2 / 8 \xi^2} \hat{H}_{\mathbf{-k}} e ^{-i \mathbf{k} \cdot \mathbf{x}_m} \\
%& =  \frac{1}{V} \sum_{\mathbf{k} \neq 0} \mathbf{B}(\xi, \mathbf{k}) \hat{H}_{\mathbf{-k}} e^{- \eta k^2 / 8 \xi^2}  e ^{i (\mathbf{-k}) \cdot \mathbf{x}_n} \\
%& = \frac{1}{V} \sum_{\mathbf{k} \neq 0} \mathbf{B}(\xi, \mathbf{-k}) \hat{H}_{\mathbf{k}} e^{- \eta k^2 / 8 \xi^2}  e ^{i \mathbf{k} \cdot \mathbf{x}_n} \\
& = \frac{1}{V} \sum_{\mathbf{k} \neq 0} \hat{\tilde{H}}_{\mathbf{k}} e^{- \eta k^2 / 8 \xi^2}  e ^{i \mathbf{k} \cdot \mathbf{x}_m} 
\end{align}
with 
\begin{equation}
\hat{\tilde{H}}_{\mathbf{k}} := \mathbf{B}(\xi, \mathbf{-k}) \hat{H}_{\mathbf{k}} e^{-(1-\eta)k^2 / 4\xi^2} \label{eq:hat_tilde_h_formula}
\end{equation}
Then we denote $\tilde{H}(\mathbf{x}_i)$ as the inverse Fourier transform of $
\hat{\tilde{H}}_{\mathbf{k}}$.

According to the convolution argument, we have that
\begin{align}
\mathbf{u}^F (\mathbf{x}_m) & =  \left(\frac{2 \xi^2}{\pi \eta}\right)^{3/2}  \int_{\Omega} \tilde{H}(\mathbf{x}) e^{-2 \xi^2 |\mathbf{x} - \mathbf{x}_m|_{\ast}^2 / \eta} \mathtt{d} \mathbf{x} \\
& \approx \frac{V}{N_{\text{grid}}} \left(\frac{2 \xi^2}{\pi \eta}\right)^{3/2} \sum_{\mathbf{x}_{(i)} \ \text{in equi-space grid}} \tilde{H}(\mathbf{x}_{(i)}) e^{-2 \xi^2 |\mathbf{x}_{(i)} - \mathbf{x}_m|_{\ast}^2 / \eta} \label{eq:gaussian_gridding_2}
\end{align}
The approximation integral is spectrally accurate since the integrand is periodic.

Now the only left problem is how to compute Eq.\eqref{eq:gaussian_gridding_1} and Eq.\eqref{eq:gaussian_gridding_2}. The formula is known as \textbf{Gaussian gridding}.

\paragraph{Fast Gaussian Gridding} The idea of fast Gaussian gridding is pre-compute and store the exponential and only do necessary multiplications.

Roughly speaking, for 1D situation, we have that ($x_{(i)} = ih$)
\begin{equation}
e^{-\alpha|x_{(i)} - x_n|^2} = e^{-\alpha|ih - x_n|^2} = e^{-\alpha (ih)^2} \left(e^{2 \alpha h x_n}\right)^i e^{-\alpha x_n^2}
\end{equation}
All $e^{-\alpha (ih)^2}, e^{2 \alpha h x_n}, e^{-\alpha x_n^2}$ can be precomputed and then each time we only need to do some multiplications. 

\textit{Remark from Guanchun: It's said to be 5 to 10 times faster in 2D than naive method and will perform better in higher dimension. However, I was wondering if we do the naive matrix multiplication on GPU, maybe it's still fast enough?}

\paragraph{The Description of Algorithm}
The algorithm is conducted in the following way:
\begin{enumerate}[(1)]
	\item Choose the free parameter $\xi$ and $\eta$ wisely and construct the uniform grid according to the problem.
	\item Evaluate $H(\mathbf{x})$ on the grid according to Eq.\eqref{eq:gaussian_gridding_1} with fast Gaussian gridding.
	\item Conduct FFT on $H(\mathbf{x})$ to get $\hat{H}_{\mathbf{k}}$.
	\item Apply the scaling according to Eq.\eqref{eq:hat_tilde_h_formula} to get $\hat{\tilde{H}}_{\mathbf{k}}$.
	\item Conduct iFFT on $\hat{\tilde{H}}_{\mathbf{k}}$ to get $\tilde{H}(\mathbf{x})$.
	\item Evaluate the $\mathbf{u}^F (\mathbf{x}_m)$ according to Eq.\eqref{eq:gaussian_gridding_2} with fast Gaussian gridding.
	\item Evaluate the $\mathbf{u}^R (\mathbf{x}_m)$ in real space and get the final result.
\end{enumerate}

\paragraph{Pseudo-code}

\end{document}